// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema



generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Adicione a role 'GUEST'
enum Role {
  ADMIN
  CUSTOMER
  GUEST // Adicionado
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentGateway {
  PUSHINPAY
  SYNCPAY
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String?
  // REMOVA O DEFAULT TEMPORARIAMENTE
  role      Role
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  orders          Order[]
  bitcoinPayments BitcoinPayment[]

  @@map("users")
}

// O enum ainda deve ter GUEST


model Product {
  id              String   @id @default(uuid())
  name            String
  description     String   @db.Text
  imageUrl        String
  previewMediaUrl String?  // Optional preview media (video/image/gif) URL
  isActive        Boolean  @default(true)
  telegramLink    String?  // External Telegram link for non-BR purchases
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  prices        Price[]
  regions       ProductRegion[]

  @@map("products")
}

model Price {
  id           String   @id @default(uuid())
  amount       Float
  currency     String   // e.g., "BRL", "USD", "EUR"
  category     String   // e.g., "HD", "4K", "SD"
  deliveryLink String   // The specific download link for this price tier
  productId    String

  product         Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  orders          Order[]
  bitcoinPayments BitcoinPayment[]

  @@map("prices")
}

model Order {
  id                   String         @id @default(uuid())
  status               OrderStatus    @default(PENDING)
  userId               String
  priceId              String?
  gateway              PaymentGateway @default(PUSHINPAY) // Payment gateway used
  pushinpayTxId        String?        // PushinPay transaction ID
  syncpayTxId          String?        // SyncPay transaction ID
  downloadLink         String?        // Generated upon completion
  createdAt            DateTime       @default(now())

  user                 User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  price                Price?         @relation(fields: [priceId], references: [id], onDelete: SetNull)

  @@index([pushinpayTxId])
  @@index([syncpayTxId])
  @@map("orders")
}

model ProductRegion {
  id          String   @id @default(uuid())
  productId   String
  countryCode String   // ISO 2-letter code, e.g., "BR", "US", "ES"

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, countryCode])
  @@map("product_regions")
}

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model PopupConfig {
  id         String   @id @default(uuid())
  message    String   @db.Text
  buttonText String
  buttonLink String
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("popup_configs")
}

model MetaPixelConfig {
  id                      String   @id @default(uuid())
  name                    String   // Nome do pixel para identificação
  pixelId                 String   // Meta Pixel ID
  accessToken             String   @db.Text // Access Token da Meta Conversions API
  pixelType               String   @default("standard") // Tipo do pixel (standard, advanced, etc.)
  enablePageView          Boolean  @default(true)  // Habilitar evento PageView
  enablePurchase          Boolean  @default(true)  // Habilitar evento Purchase
  enableInitiateCheckout  Boolean  @default(true)  // Habilitar evento InitiateCheckout
  isActive                Boolean  @default(true)  // Se o pixel está ativo
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("meta_pixel_configs")
}

enum BitcoinPaymentStatus {
  PENDING
  AWAITING_CONFIRMATION
  COMPLETED
  EXPIRED
  FAILED
}

model BitcoinPayment {
  id                String               @id @default(uuid())
  userId            String
  priceId           String
  amountUsd         Float                // Valor em dólares
  amountBtc         Float                // Valor em Bitcoin
  btcRate           Float                // Taxa de conversão USD->BTC no momento
  feePercentage     Float                @default(3.0) // Taxa adicional (%)
  walletAddress     String               // Endereço da carteira para receber
  derivationIndex   Int?                 // Índice de derivação do HD wallet (se usado)
  status            BitcoinPaymentStatus @default(PENDING)
  txHash            String?              // Hash da transação Bitcoin (após confirmação)
  downloadLink      String?              // Link de download (após confirmação)
  expiresAt         DateTime             // Expira após 24 horas
  confirmedAt       DateTime?            // Quando foi confirmado
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  price             Price                @relation(fields: [priceId], references: [id], onDelete: Cascade)

  @@index([walletAddress])
  @@index([status])
  @@index([derivationIndex])
  @@map("bitcoin_payments")
}
